# 评论缓存设计

### 1. 业务场景

在高并发系统中，评论经常被查看与点赞，我们在展示评论列表的时候，按点赞数和评论时间综合排序，对于评论业务，应该如何设计缓存策略？

### 2.技术选型

评论是一种需要持久化的数据，主储存靠考虑使用TiDB等高性能关系数据库，通过合理的表设计来解决缓存大key的问题。

**1️⃣ 评论主题表（Comment Topic）**

作用：评论的“桶”

comment_topic

- topic_id        (视频 / 帖子 / 商品)
- comment_count
- hot_count
- status

为什么要单独一层？

评论总数、关闭评论、风控

快速判断：有没有评论

避免每次都扫评论表这是“评论的元数据层”

**2️⃣ 评论索引表（Comment Index）**

存放评论的索引与树形结构，表示评论的回复、父子等关系

comment_index

- topic_id
- comment_id
- parent_id
- order_key   (时间 / 热度 / 综合权重)
- level

不存 content，一条记录非常小，专门为：分页/排序/层级业务设计

**3️⃣ 评论内容表（Comment Content）**
comment_content

- comment_id
- user_id
- content
- extra (图片 / 表情 / @)

这一层的特点为IO 重、字段多、更新少，天然适合缓存

### 3.总结

这套技术架构核心在表设计上，将评论内容与评论结构进行了解耦，在实际实现的时候，我们只缓存评论内容，可以考虑使用异步编排来进一步优化整体响应时间。
