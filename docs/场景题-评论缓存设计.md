# 🗨️评论缓存设计

### 1. 业务场景

在高并发系统中，评论经常被查看与点赞，我们在展示评论列表的时候，按点赞数和评论时间综合排序，对于评论业务，应该如何设计缓存策略？

---

### 2.技术选型

评论是一种需要持久化的数据，主储存靠考虑使用TiDB等高性能关系数据库，通过合理的表设计来解决缓存大key的问题。

##### 1️⃣ 评论主题表 Comment Topic

作用：评论的“桶”，即评论的整体信息。

```sql
comment_topic

- topic_id # 视频 / 帖子 / 商品
- comment_count # 总评论数统计
- hot_count # 热度评分
- status # 状态等其它字段
```

**为什么要单独一层？**

1. 评论总数、关闭评论、风控

2. 快速判断：有没有评论

3. 避免每次都扫评论表这是“评论的元数据层”

##### 2️⃣ 评论索引表 Comment Index

存放评论的索引与树形结构，表示评论的回复、父子等关系

```sql
comment_index

- topic_id # 主题id，根据业务决定，比如视频评论就是视频编号
- comment_id # 评论记录id
- parent_id # 父评论id，如果为 0 即为顶级评论
- order_key # 排序字段等
- root # 回复评论，如果为 0 即为非回复评论
```

不存 content，一条记录非常小，专门为：分页/排序/层级业务设计

##### 3️⃣ 评论内容表 Comment Content

```sql
comment_content

- comment_id # 评论id
- user_id # 用户id
- content # 文本内容
- extra # 图片 / 表情 / @
```

这一层的特点为IO 重、字段多、更新少，天然适合缓存

---

### 3.总结

> 这套技术架构核心在表设计上，将评论内容与评论结构进行了解耦，在实际实现的时候，我们只缓存评论内容，可以考虑使用异步编排来进一步优化整体响应时间。
