import{_ as i,c as a,o as n,aj as t}from"./chunks/framework.BZD6ashX.js";const c=JSON.parse('{"title":"🗨️评论缓存设计","description":"","frontmatter":{},"headers":[],"relativePath":"场景题-评论缓存设计.md","filePath":"场景题-评论缓存设计.md"}'),e={name:"场景题-评论缓存设计.md"};function l(h,s,p,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[t(`<h1 id="🗨️评论缓存设计" tabindex="-1">🗨️评论缓存设计 <a class="header-anchor" href="#🗨️评论缓存设计" aria-label="Permalink to “🗨️评论缓存设计”">​</a></h1><h3 id="_1-业务场景" tabindex="-1">1. 业务场景 <a class="header-anchor" href="#_1-业务场景" aria-label="Permalink to “1. 业务场景”">​</a></h3><p>在高并发系统中，评论经常被查看与点赞，我们在展示评论列表的时候，按点赞数和评论时间综合排序，对于评论业务，应该如何设计缓存策略？</p><hr><h3 id="_2-技术选型" tabindex="-1">2.技术选型 <a class="header-anchor" href="#_2-技术选型" aria-label="Permalink to “2.技术选型”">​</a></h3><p>评论是一种需要持久化的数据，主储存靠考虑使用TiDB等高性能关系数据库，通过合理的表设计来解决缓存大key的问题。</p><h5 id="_1️⃣-评论主题表-comment-topic" tabindex="-1">1️⃣ 评论主题表 Comment Topic <a class="header-anchor" href="#_1️⃣-评论主题表-comment-topic" aria-label="Permalink to “1️⃣ 评论主题表 Comment Topic”">​</a></h5><p>作用：评论的“桶”，即评论的整体信息。</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">comment_topic</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> topic_id # 视频 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 帖子 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 商品</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> comment_count # 总评论数统计</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> hot_count # 热度评分</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> status</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> # 状态等其它字段</span></span></code></pre></div><p><strong>为什么要单独一层？</strong></p><ol><li><p>评论总数、关闭评论、风控</p></li><li><p>快速判断：有没有评论</p></li><li><p>避免每次都扫评论表这是“评论的元数据层”</p></li></ol><h5 id="_2️⃣-评论索引表-comment-index" tabindex="-1">2️⃣ 评论索引表 Comment Index <a class="header-anchor" href="#_2️⃣-评论索引表-comment-index" aria-label="Permalink to “2️⃣ 评论索引表 Comment Index”">​</a></h5><p>存放评论的索引与树形结构，表示评论的回复、父子等关系</p><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">comment_index</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> topic_id # 主题id，根据业务决定，比如视频评论就是视频编号</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> comment_id # 评论记录id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> parent_id # 父评论id，如果为 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 即为顶级评论</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> order_key # 排序字段等</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> root</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> # 回复评论，如果为 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 即为非回复评论</span></span></code></pre></div><p>不存 content，一条记录非常小，专门为：分页/排序/层级业务设计</p><h5 id="_3️⃣-评论内容表-comment-content" tabindex="-1">3️⃣ 评论内容表 Comment Content <a class="header-anchor" href="#_3️⃣-评论内容表-comment-content" aria-label="Permalink to “3️⃣ 评论内容表 Comment Content”">​</a></h5><div class="language-sql"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">comment_content</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> comment_id # 评论id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> user_id # 用户id</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> content # 文本内容</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> extra # 图片 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 表情 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> @</span></span></code></pre></div><p>这一层的特点为IO 重、字段多、更新少，天然适合缓存</p><hr><h3 id="_3-总结" tabindex="-1">3.总结 <a class="header-anchor" href="#_3-总结" aria-label="Permalink to “3.总结”">​</a></h3><blockquote><p>这套技术架构核心在表设计上，将评论内容与评论结构进行了解耦，在实际实现的时候，我们只缓存评论内容，可以考虑使用异步编排来进一步优化整体响应时间。</p></blockquote>`,21)])])}const E=i(e,[["render",l]]);export{c as __pageData,E as default};
