<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>🚟消息队列 | Bagu for me and for all</title>
    <meta name="description" content="We need bagu to get a f**king job!">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/bagu/assets/style.Cpgg9TW0.css" as="style">
    <link rel="preload stylesheet" href="/bagu/vp-icons.css" as="style">
    
    <script type="module" src="/bagu/assets/app.BHe_nXvt.js"></script>
    <link rel="preload" href="/bagu/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/bagu/assets/chunks/theme.X3c_qVn7.js">
    <link rel="modulepreload" href="/bagu/assets/chunks/framework.BZD6ashX.js">
    <link rel="modulepreload" href="/bagu/assets/消息队列.md.BMCSJmon.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/bagu/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>Bagu for me and for all</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!--[--><!----><div id="local-search"><button type="button" aria-label="Search" aria-keyshortcuts="/ control+k meta+k" class="DocSearch DocSearch-Button"><span class="DocSearch-Button-Container"><span class="vpi-search DocSearch-Search-Icon"></span><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key"></kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/Java%E4%B8%8E%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9F%BA%E7%A1%80.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>JDK与数据结构</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/%E6%95%B0%E6%8D%AE%E5%BA%93.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>数据库</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/Elasticsearch.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Elasticsearch</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/LLM%E4%B8%8EAgent.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>LLM与Agent</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/Spring.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Spring</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/JVM.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>JVM与性能调优</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/bagu/%E9%AB%98%E6%80%A7%E8%83%BDRedis.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>高性能Redis</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink active" href="/bagu/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97.html" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>消息队列</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/l0sgAi" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/l0sgAi" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav empty fixed" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><!----><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><!----><div class="VPContent" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _bagu_%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97" data-v-7011f0d8><div><h1 id="🚟消息队列" tabindex="-1">🚟消息队列 <a class="header-anchor" href="#🚟消息队列" aria-label="Permalink to “🚟消息队列”">​</a></h1><h3 id="i-如何解决消息丢失问题" tabindex="-1">I. 如何解决消息丢失问题？ <a class="header-anchor" href="#i-如何解决消息丢失问题" aria-label="Permalink to “I. 如何解决消息丢失问题？”">​</a></h3><p>消息丢失可能发生在三个阶段，我们需要分段治理：</p><h4 id="_1-生产者丢失消息-producer-➡️-broker" tabindex="-1">1. 生产者丢失消息（Producer ➡️ Broker） <a class="header-anchor" href="#_1-生产者丢失消息-producer-➡️-broker" aria-label="Permalink to “1. 生产者丢失消息（Producer ➡️ Broker）”">​</a></h4><p><strong>原因</strong>：网络波动、Broker 宕机，导致消息根本没发到 Broker，但生产者以为发了。<br><strong>解决方案</strong>：</p><ul><li><p><strong>开启发布确认机制 (Publisher Confirm)</strong>：</p><ul><li><p>生产者将 Channel 设置为 confirm 模式。</p></li><li><p>每发送一条消息，Broker 收到并写入磁盘后，会给生产者回传一个 ACK。</p></li><li><p>如果生产者没收到 ACK（或收到 NACK），就重试发送。</p></li></ul></li><li><p><strong>备选：事务机制 (Transaction)</strong>：虽然也能保证安全，但性能极差，通常不推荐。</p></li></ul><h4 id="_2-broker-丢失消息-broker-自身" tabindex="-1">2. Broker 丢失消息（Broker 自身） <a class="header-anchor" href="#_2-broker-丢失消息-broker-自身" aria-label="Permalink to “2. Broker 丢失消息（Broker 自身）”">​</a></h4><p><strong>原因</strong>：Broker 接收到了消息，但还没来得及写入磁盘就宕机了（内存数据丢失）。<br><strong>解决方案</strong>：<strong>持久化 (Persistence)</strong>。<br> 需要同时做3️⃣件事，缺一不可：</p><ol><li><p><strong>Exchange 持久化</strong>：声明交换机时 durable=true。</p></li><li><p><strong>Queue 持久化</strong>：声明队列时 durable=true。</p></li><li><p><strong>Message 持久化</strong>：发送消息时设置投递模式 deliveryMode=2。</p></li></ol><h4 id="_3-消费者丢失消息-broker-➡️-consumer" tabindex="-1">3. 消费者丢失消息（Broker ➡️ Consumer） <a class="header-anchor" href="#_3-消费者丢失消息-broker-➡️-consumer" aria-label="Permalink to “3. 消费者丢失消息（Broker ➡️ Consumer）”">​</a></h4><p><strong>原因</strong>：消费者开启了“自动确认”（Auto Ack）。消息刚被消费者接收（还在内存中没处理），消费者进程挂了，Broker 以为已经消费成功，就把消息删了。<br><strong>解决方案</strong>：</p><ul><li><p><strong>关闭自动确认，开启手动确认 (Manual Ack)</strong>。</p></li><li><p>消费者在业务逻辑<strong>完全处理成功后</strong>，才调用 channel.basicAck() 告诉 Broker 可以删除消息。</p></li><li><p>如果处理失败，可以调用 basicNack 或 basicReject 让消息重新入队。</p></li></ul><hr><h3 id="ii-如何解决消息重复问题" tabindex="-1">II. 如何解决消息重复问题？ <a class="header-anchor" href="#ii-如何解决消息重复问题" aria-label="Permalink to “II.  如何解决消息重复问题？”">​</a></h3><p><strong>原因</strong>：</p><ul><li><p><strong>网络抖动</strong>：生产者发了消息，Broker 收到了，但回传 ACK 时网络断了。生产者以为失败了，就重发了一次。</p></li><li><p><strong>消费者故障</strong>：消费者处理完了业务，还没来得及发 ACK 就挂了。Broker 以为没处理，就把消息发给另一个消费者。</p></li></ul><p><strong>解决方案</strong>：<br> 消息重复在分布式系统中是<strong>无法完全避免</strong>的（为了保证不丢失，通常采用“至少一次投递”策略）。<br> 所以，解决方案的核心不在于“不让它重复发”，而在于<strong>消费者端的幂等性 (Idempotency) 处理</strong>。</p><p><strong>具体手段</strong>：</p><ol><li><p><strong>数据库唯一约束 (最强硬手段)</strong>：</p><ul><li><p>给每条消息生成一个全局唯一的 ID（MessageID 或业务 ID，如订单号）。</p></li><li><p>消费时，尝试向数据库（或去重表）插入这个 ID。</p></li><li><p>如果插入成功，则执行业务；如果报错（主键冲突），说明已经消费过，直接丢弃或 ACK。</p></li></ul></li><li><p><strong>Redis 原子操作 (性能较好)</strong>：</p><ul><li><p>利用 SETNX (set if not exists) 命令。</p></li><li><p>Key 为消息 ID，Value 为状态。</p></li><li><p>处理前先 SETNX，返回 true 则处理，返回 false 则说明正在处理或已处理。</p></li></ul></li><li><p><strong>乐观锁/版本号</strong>：</p><ul><li>如果是更新操作，带上版本号条件：UPDATE table SET count = count + 1, version = version + 1 WHERE id = 1 AND version = 1。</li></ul></li></ol><hr><h3 id="iii-如何解决消息积压问题" tabindex="-1">III. 如何解决消息积压问题？ <a class="header-anchor" href="#iii-如何解决消息积压问题" aria-label="Permalink to “III. 如何解决消息积压问题？”">​</a></h3><p><strong>表现</strong>：</p><ul><li><p>消费者挂了。</p></li><li><p>消费者处理速度太慢（代码逻辑耗时、数据库瓶颈）。</p></li><li><p>生产者发送流量突然暴涨（秒杀活动）。</p></li></ul><p><strong>根本原因：</strong></p><ul><li><p>业务设计与实际流量不匹配。</p></li><li><p>偶然的、未在设计预期内的短时高流量。</p></li></ul><p><strong>解决方案</strong>：</p><h4 id="_1-紧急处理-线上已经积压了怎么办" tabindex="-1">1. 紧急处理（线上已经积压了怎么办？） <a class="header-anchor" href="#_1-紧急处理-线上已经积压了怎么办" aria-label="Permalink to “1. 紧急处理（线上已经积压了怎么办？）”">​</a></h4><p>如果积压了几百万条消息，直接加消费者可能来不及，或者数据库扛不住。<br><strong>临时扩容方案</strong>：</p><ol><li><p><strong>修复消费者</strong>：先确保消费者逻辑没 Bug。</p></li><li><p><strong>限流、降级</strong>：停止现有消费者，或者将它们降级。</p></li><li><p><strong>部署大量消费者</strong>：临时部署 10-20 倍的消费者节点，专门消费那些临时队列。</p></li><li><p><strong>恢复</strong>：积压消费完后，恢复原有架构。</p></li></ol><h4 id="_2-预防措施-长期治理" tabindex="-1">2. 预防措施（长期治理） <a class="header-anchor" href="#_2-预防措施-长期治理" aria-label="Permalink to “2. 预防措施（长期治理）”">​</a></h4><ul><li><p><strong>重新评估架构和业务设计：</strong> 结合实际情况重构、优化代码，使得消费者的处理速度与业务需求相匹配</p></li><li><p><strong>优化消费者代码</strong>：采用异步处理、批量处理、优化 SQL。</p></li><li><p><strong>增加消费者数量</strong>：利用 RabbitMQ 的 Work Queues 模式，横向扩展消费者实例。</p></li><li><p><strong>设置预取数量 (Prefetch Count)</strong>：不要让消费者一次拉取太多消息导致内存溢出，设置合理的 basicQos，让消费者“按需干活”。</p></li><li><p><strong>死信队列 (DLQ)</strong>：给队列设置 TTL（过期时间），过期的消息进入死信队列，避免堵塞主队列，事后人工处理死信，也可以自动+人工处理相结合。</p></li></ul><hr><h3 id="总结表格" tabindex="-1">总结表格 <a class="header-anchor" href="#总结表格" aria-label="Permalink to “总结表格”">​</a></h3><table tabindex="0"><thead><tr><th>问题</th><th>核心发生点</th><th>核心解决方案</th><th>关键词</th></tr></thead><tbody><tr><td><strong>消息丢失</strong></td><td>发送端、Broker、消费端</td><td>确认机制 + 持久化 + 手动 ACK</td><td>Publisher Confirm, Durable, Manual Ack</td></tr><tr><td><strong>消息重复</strong></td><td>网络波动、ACK 丢失</td><td>消费者端做<strong>幂等性</strong>处理</td><td>唯一 ID, Redis SETNX, 数据库唯一索引</td></tr><tr><td><strong>消息积压</strong></td><td>生产快、消费慢</td><td>临时扩容队列 + 分发逻辑</td><td>临时队列, 横向扩展, 异步优化</td></tr></tbody></table></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><!----></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"api-examples.md\":\"DdeUUmLM\",\"elasticsearch.md\":\"Co7woVhU\",\"index.md\":\"BJepNdkD\",\"java与数据结构基础.md\":\"CiLlqZFp\",\"jvm.md\":\"Dw5KLLW8\",\"llm与agent.md\":\"0Saw8V-N\",\"markdown-examples.md\":\"CIl-LM3l\",\"spring.md\":\"I8k0JqHu\",\"场景题-点赞系统设计.md\":\"q-DaUAga\",\"场景题-评论缓存设计.md\":\"KYsG2qBi\",\"数据库.md\":\"BOFkCrXm\",\"消息队列.md\":\"BMCSJmon\",\"高性能redis.md\":\"BQpWY_zH\",\"高性能弹幕系统.md\":\"BZfkal9d\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Bagu for me and for all\",\"description\":\"We need bagu to get a f**king job!\",\"base\":\"/bagu/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"JDK与数据结构\",\"link\":\"/Java与数据结构基础\"},{\"text\":\"数据库\",\"link\":\"/数据库\"},{\"text\":\"Elasticsearch\",\"link\":\"/Elasticsearch\"},{\"text\":\"LLM与Agent\",\"link\":\"/LLM与Agent\"},{\"text\":\"Spring\",\"link\":\"/Spring\"},{\"text\":\"JVM与性能调优\",\"link\":\"/JVM\"},{\"text\":\"高性能Redis\",\"link\":\"/高性能Redis\"},{\"text\":\"消息队列\",\"link\":\"/消息队列\"}],\"search\":{\"provider\":\"local\"},\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/l0sgAi\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}");</script>
    
  </body>
</html>