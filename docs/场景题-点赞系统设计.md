# ç³»ç»Ÿè®¾è®¡å®æˆ˜ï¼šé«˜æ€§èƒ½ç‚¹èµä¸è¯„è®ºç³»ç»Ÿè®¾è®¡åˆ†äº«-ä»¥ç§Ÿè½¦ä¸šåŠ¡ä¸ºä¾‹

## èƒŒæ™¯

æœ€è¿‘æˆ‘åœ¨å¼€å‘ä¸€ä¸ªç§Ÿè½¦ç½‘ç«™ï¼Œåœ¨è½¦è¾†è¯¦æƒ…é¡µé¢è®¡åˆ’å®ç°ä¸€ä¸ªè¯„è®ºåŒºï¼Œåœ¨å®é™…çš„å®ç°è¿‡ç¨‹ä¸­å‘ç°è¿™ä¸ªè¯„è®ºå’Œç‚¹èµç³»ç»Ÿçš„è®¾è®¡ï¼Œè¿˜çœŸä¸é‚£ä¹ˆç®€å•ã€‚ç»è¿‡æ•°æ—¥çš„æ‘¸ç´¢ï¼Œç°åœ¨æŠŠè®¾è®¡ä¸å®ç°çš„ç»éªŒåˆ†äº«ç»™å¤§å®¶

> ä»£ç ä»“åº“ï¼š[GitHub - l0sgAi/car-rental-backend at new_comment](https://github.com/l0sgAi/car-rental-backend/tree/new_comment)

---

## I. ç‚¹èµç³»ç»Ÿ

ç‚¹èµä½œä¸ºä¸€ä¸ªé«˜é¢‘è¯»å†™çš„ä¸šåŠ¡ï¼Œæˆ‘ä»¬å°½é‡åœ¨Redisä¸Šåšè¯»å†™ã€‚å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ç»´æŠ¤2ä¸ªkeyï¼š

1. ç”¨æˆ·ç‚¹èµçš„è¯„è®ºåˆ—è¡¨setï¼Œç»“æ„ä¸º[ç”¨æˆ·ID:ç‚¹èµè¯„è®ºIDé›†åˆ]

2. è¯„è®ºçš„ç‚¹èµè®¡æ•°countï¼Œç»“æ„ä¸º[è¯„è®ºID:ç‚¹èµæ€»æ•°]

â›”**ç„¶è€Œ**ï¼Œè¿™æ ·ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šç”¨æˆ·ç‚¹èµçš„è¯„è®ºåˆ—è¡¨setï¼Œæˆ‘ä»¬ä¸ºäº†é˜²æ­¢å¤§keyé—®é¢˜ï¼Œå¿…é¡»è¦å¯¹setçš„å¤§å°åšé™åˆ¶ï¼Œè¿™ä¼šå¯¼è‡´å¦‚æœç”¨æˆ·çš„æ€»ç‚¹èµæ•°è¶…è¿‡æŸä¸€ä¸ªä¸Šé™ï¼Œåœ¨ä¹‹åçš„ç‚¹èµåˆ—è¡¨åŒæ­¥çš„æ—¶å€™ï¼Œä¼šæŠŠæœ€è€çš„ä¸€æ‰¹ç‚¹èµè®°å½•æ·˜æ±°ï¼Œå¯¼è‡´æœ‰çš„ç‚¹èµå¯ä»¥è¢«é‡å¤è§¦å‘ã€‚

> è¿™ä¸ªé—®é¢˜ç›®å‰æˆ‘è¿˜æ²¡æ‰¾åˆ°å¾ˆå¥½çš„è§£å†³æ–¹æ³•ï¼Œå¦‚æœæœ‰äººäº†è§£çš„è¯æ¬¢è¿æå‡ºå®è´µæ„è§ã€‚

ä¸€èˆ¬æ¥è¯´ï¼Œç‚¹èµä½œä¸ºå¼±ä¸€è‡´æ€§ä¸šåŠ¡ï¼Œè¿™ä¸ªè¯¯å·®ä¹Ÿä¸æ˜¯ä¸èƒ½æ¥å—ï¼Œæ¯”å¦‚è®¾ç½®ä¸€ä¸ªå®¹é‡5000çš„setï¼Œå¯¹äºå¤§éƒ¨åˆ†ç”¨æˆ·ï¼Œä¸€å¤©çš„ç‚¹èµæ•°é‡ä¸è¶…è¿‡10ä¸ªï¼Œå³ç”¨æˆ·è¦å°†è¿‘2å¹´æ‰èƒ½å¡«æ»¡ç‚¹èµåˆ—è¡¨ã€‚è€Œå¯¹ä¸€ä¸ª2å¹´å‰çš„ç‚¹èµï¼Œå…è®¸é‡æ–°è®°å½•ä¹Ÿä¸æ˜¯ä¸èƒ½æ¥å—ã€‚

### 1. è¡¨è®¾è®¡

##### ç‚¹èµè®°å½•è¡¨

ç‚¹èµè¡¨é€šè¿‡å”¯ä¸€ç´¢å¼•ï¼Œå°½é‡å‡å°‘è¡¨ä¸­çš„æ•°æ®é‡ï¼Œæå‡ä¸šåŠ¡çš„é€»è¾‘æ¸…æ™°åº¦ã€‚

```sql
-- ç‚¹èµè¡¨
CREATE TABLE `like`
(
    `id`          bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',
    `user_id`     bigint unsigned NOT NULL COMMENT 'å¯¹åº”ç”¨æˆ·ID',
    `comment_id`  bigint unsigned NOT NULL COMMENT 'å¯¹åº”è¯„è®ºID',
    `create_time` datetime        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    `is_dislike` tinyint         NOT NULL DEFAULT '0' COMMENT 'æ ‡å¿—æ“ä½œç±»å‹ï¼Œæ˜¯å¦ä¸ºå–æ¶ˆç‚¹èµï¼Œç±»ä¼¼é€»è¾‘åˆ é™¤ï¼š0=ç‚¹èµï¼Œ1=å·²å–æ¶ˆç‚¹èµ',
    PRIMARY KEY (`id`)
) ENGINE = InnoDB
  AUTO_INCREMENT = 1
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_0900_ai_ci COMMENT ='ç‚¹èµä¿¡æ¯è¡¨';

-- æ·»åŠ å”¯ä¸€ç´¢å¼•
ALTER TABLE `like`
    ADD UNIQUE KEY uk_user_comment (user_id, comment_id); 
```

### 2. ç‚¹èµ/å–æ¶ˆç‚¹èµçš„å®ç°

**å…¥å‚**ï¼šè¯„è®ºidä¸ç”¨æˆ·id

ç‚¹èµ/å–æ¶ˆç‚¹èµçš„é€»è¾‘é“¾è·¯å¦‚ä¸‹ï¼š

1. æ£€æŸ¥æœ‰å…³ç‚¹èµçš„2ä¸ªkeyæ˜¯å¦å­˜åœ¨ï¼ŒåŒ…æ‹¬ç‚¹èµè®¡æ•°å’Œç‚¹èµåˆ—è¡¨ï¼Œæ²¡æœ‰çš„è¯éœ€è¦é‡å»ºç¼“å­˜ï¼Œåœ¨é‡å»ºè¿‡ç¨‹ä¸­åŠ åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿ã€‚

2. æ£€æŸ¥ç‚¹èµåˆ—è¡¨ï¼Œå¯¹æ¯”å½“å‰ç”¨æˆ·idï¼Œå¦‚æœç‚¹èµåˆ—è¡¨ä¸­æœ‰å¯¹åº”ç”¨æˆ·idï¼Œè¯´æ˜æ˜¯å–æ¶ˆç‚¹èµæ“ä½œï¼ŒæŠŠuserIdä»ç‚¹èµåˆ—è¡¨ç§»é™¤ï¼Œå¹¶æŠŠç‚¹èµè®¡æ•°-1ã€‚åä¹‹å¾€ç‚¹èµåˆ—è¡¨æ·»åŠ userIdå¹¶æŠŠç‚¹èµè®¡æ•°+1ï¼Œè¾¾æˆç‚¹èµã€‚

3. æœ€åå¾€MQé‡Œé¢å‘ä¸€æ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…æ ¹æ®æ—¶é—´ç»´åº¦(æ¯”å¦‚3ç§’)ï¼Œå¯¹ä¸€æ®µæ—¶é—´å†…çš„ç‚¹èµæ¶ˆæ¯è¿›è¡Œèšåˆï¼Œæ‰¹é‡å…¥åº“ã€‚

##### **2.1 ç‚¹èµå®ç°å‚è€ƒ**ï¼š

>  è¿™é‡Œå¯ä»¥ä½¿ç”¨luaè„šæœ¬å®ç°ç‚¹èµæ“ä½œï¼Œæå‡æ€§èƒ½ï¼Œä¿è¯æ“ä½œåŸå­æ€§ã€‚

```java
@Override
@Description("ç‚¹èµ/å–æ¶ˆç‚¹èµ (LuaåŸå­ç‰ˆ)")
public ResultCodeEnum like(Long commentId, Long userId) {
    if (commentId == null || userId == null) {
        return ResultCodeEnum.DATA_ERROR;
    }

    String userSetKey = USER_LIKE_KEY_PREFIX + userId;
    String countKey = LIKE_COUN_KEY_PREFIX + commentId;

    // 1. å°è¯•æ‰§è¡Œ Lua è„šæœ¬
    // å‚æ•°è¯´æ˜ï¼šKeysåˆ—è¡¨, ARGVåˆ—è¡¨
    long result = executeLikeScript(userSetKey, countKey, commentId);

    // 2. å¦‚æœè¿”å› -1ï¼Œè¯´æ˜ç¼“å­˜ç¼ºå¤±ï¼Œéœ€è¦é‡å»º
    if (result == -1) {
        log.info("ç¼“å­˜ç¼ºå¤±ï¼Œæ‰§è¡Œé‡å»ºé€»è¾‘... uid:{}, cid:{}", userId, commentId);

        // é‡å»ºä¸¤ä¸ªç¼“å­˜
        rebuildUserLikedCache(userId);
        rebuildCommentCountCache(commentId);

        // å†æ¬¡æ‰§è¡Œ Lua è„šæœ¬
        result = executeLikeScript(userSetKey, countKey, commentId);

        // å¦‚æœè¿˜æ˜¯ -1ï¼Œè¯´æ˜é‡å»ºå¤±è´¥æˆ–è€…ç³»ç»Ÿå¼‚å¸¸ï¼Œåšä¸ªå…œåº•
        if (result == -1) {
            return ResultCodeEnum.SYSTEM_ERROR;
        }
    }

    // 3. æ ¹æ®ç»“æœè¿”å›
    // æˆ–è€…è¿”å›ç‰¹å®šæšä¸¾ UNLIKED
    if (result == 1) {
        log.info("ç‚¹èµæˆåŠŸ");
    } else {
        log.info("å–æ¶ˆç‚¹èµæˆåŠŸ");
    }
    // æ¶ˆæ¯é˜Ÿåˆ—å‘é€ç‚¹èµè®°å½•å…¥åº“å’Œç‚¹èµæ•°é‡æ›´æ–°è¯·æ±‚
    Like like = new Like();
    like.setUserId(userId);
    like.setCommentId(commentId);
    like.setIsFallback(result == 1 ? 0 : 1);
    like.setCreateTime(Date.from(Instant.now()));
    sender.sendLikeSync(RabbitMQMessageConfig.EXCHANGE_NAME, RabbitMQMessageConfig.ROUTING_KEY_LIKE, like);
    return ResultCodeEnum.SUCCESS;
}
```

##### **2.2 æ‰§è¡Œè„šæœ¬çš„æ–¹æ³•**ï¼š

```java
private Long executeLikeScript(String userSetKey, String countKey, Long commentId) {
    return redisTemplate.execute(
            likeScript,
            Arrays.asList(userSetKey, countKey), // KEYS
            commentId, // ARGV[1]
            7 * 24 * 60 * 60, // ARGV[2] UserSetè¿‡æœŸæ—¶é—´ 7å¤©
            24 * 60 * 60 // ARGV[3] Countè¿‡æœŸæ—¶é—´ 1å¤©
    );
}
```

##### **2.3 é‡å»ºç¼“å­˜çš„æ–¹æ³•**ï¼š

```java
/**
 * é‡å»ºè¯„è®ºç‚¹èµæ•°ç¼“å­˜ (åªè´Ÿè´£ Count)
 * è°ƒç”¨æ—¶æœºï¼šGET article:count:{id} è¿”å› null æ—¶
 */
@Description("æ ¹æ®commentIdé‡å»ºç‚¹èµæ•°ç¼“å­˜")
private void rebuildCommentCountCache(Long commentId) {
    String countKey = LIKE_COUNT_KEY_PREFIX + commentId;
    // 1. ç¬¬ä¸€å±‚æ£€æŸ¥
    if (redisTemplate.hasKey(countKey)) {
        return;
    }

    RLock lock = redissonClient.getLock(LOCK_KEY_PREFIX_COMMENT_LIKE + commentId);
    try {
        // å°è¯•åŠ é”
        if (lock.tryLock(5, 10, TimeUnit.SECONDS)) {
            try {
                // 2. åŒé‡æ£€æŸ¥
                if (redisTemplate.hasKey(countKey)) {
                    return;
                }

                log.info("é‡å»ºè¯„è®ºç‚¹èµæ•°ç¼“å­˜ï¼Œid: {}", commentId);

                // 3. æŸ¥ DB
                Integer dbCount = likeMapper.countByCommentId(commentId);
                dbCount = dbCount == null ? 0 : dbCount;

                // 4. å†™ Redis
                redisTemplate.opsForValue().set(countKey, dbCount, 24, TimeUnit.HOURS);

            } finally {
                lock.unlock();
            }
        }
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
        log.error("Lock interrupted during comment count rebuild", e);
    }
}

/**
 * é‡å»ºç”¨æˆ·ç‚¹èµå†å²ç¼“å­˜ (åªè´Ÿè´£ User Set)
 * è°ƒç”¨æ—¶æœºï¼šSISMEMBER user:likes:{uid} ä¹‹å‰çš„æ£€æŸ¥å‘ç° Key ä¸å­˜åœ¨æ—¶
 */
@Description("æ ¹æ®userIdé‡å»ºç”¨æˆ·ç‚¹èµå†å²ç¼“å­˜")
private void rebuildUserLikedCache(Long userId) {
    String userSetKey = USER_LIKE_KEY_PREFIX + userId;
    // 1. ç¬¬ä¸€å±‚æ£€æŸ¥
    if (redisTemplate.hasKey(userSetKey)) {
        return;
    }

    RLock lock = redissonClient.getLock(LOCK_KEY_PREFIX_USER_LIKE + userId);
    try {
        if (lock.tryLock(5, 10, TimeUnit.SECONDS)) {
            try {
                // 2. åŒé‡æ£€æŸ¥
                if (redisTemplate.hasKey(userSetKey)) {
                    return;
                }

                log.info("é‡å»ºç”¨æˆ·ç‚¹èµå†å²ç¼“å­˜ï¼Œuid: {}", userId);

                // 3. æŸ¥ DB è¿™é‡ŒæŸ¥çš„æ˜¯ commentId åˆ—è¡¨
                List<Like> recentLikes = likeMapper.selectLatestLikes(userId, LIKE_LIMIT);

                if (CollUtil.isNotEmpty(recentLikes)) {
                    // æå– CommentId
                    Object[] commentIds = recentLikes.stream()
                            .map(Like::getCommentId)
                            .toArray(); // <--- å…³é”®ä¿®æ­£ï¼šè½¬ä¸ºæ•°ç»„

                    // 4. æ‰¹é‡å†™å…¥ Set
                    redisTemplate.opsForSet().add(userSetKey, commentIds);
                } else {
                    // 5. ç©ºå€¼å ä½é˜²ç©¿é€
                    redisTemplate.opsForSet().add(userSetKey, -1L);
                }
                // ç»Ÿä¸€è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œç”¨æˆ·å†å²å¯ä»¥ä¹…ä¸€ç‚¹
                redisTemplate.expire(userSetKey, 7, TimeUnit.DAYS);

            } finally {
                lock.unlock();
            }
        }
    } catch (InterruptedException e) {
        Thread.currentThread().interrupt();
        log.error("Lock interrupted during user history rebuild", e);
    }
}
```

##### **2.4 luaè„šæœ¬å‚è€ƒ**ï¼š

```lua
-- KEYS[1]: ç”¨æˆ·ç‚¹èµåˆ—è¡¨ Key (user:likes:{uid})
-- KEYS[2]: æ–‡ç« /è¯„è®ºç‚¹èµè®¡æ•° Key (comment:count:{cid})
-- ARGV[1]: è¯„è®º ID (commentId)
-- ARGV[2]: ç”¨æˆ·åˆ—è¡¨è¿‡æœŸæ—¶é—´ (ç§’)
-- ARGV[3]: è®¡æ•°ç¼“å­˜è¿‡æœŸæ—¶é—´ (ç§’)

-- 1. æ£€æŸ¥ç¼“å­˜æ˜¯å¦å­˜åœ¨ (å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›ç‰¹æ®Šæ ‡è®°è®© Java å±‚å»é‡å»º)
if redis.call('EXISTS', KEYS[1]) == 0 or redis.call('EXISTS', KEYS[2]) == 0 then
    return -1 -- è¿”å› -1 ä»£è¡¨ç¼“å­˜å¤±æ•ˆï¼Œéœ€è¦é‡å»º
end

-- 2. åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç‚¹èµ
local isLiked = redis.call('SISMEMBER', KEYS[1], ARGV[1])

if isLiked == 1 then
    -- === é€»è¾‘åˆ†æ”¯ï¼šå–æ¶ˆç‚¹èµ ===
    redis.call('SREM', KEYS[1], ARGV[1])
    redis.call('DECR', KEYS[2])

    -- ç»­æœŸ
    redis.call('EXPIRE', KEYS[1], ARGV[2])
    redis.call('EXPIRE', KEYS[2], ARGV[3])

    return 0 -- è¿”å› 0 ä»£è¡¨å–æ¶ˆç‚¹èµæˆåŠŸ
else
    -- === é€»è¾‘åˆ†æ”¯ï¼šæ‰§è¡Œç‚¹èµ ===
    redis.call('SADD', KEYS[1], ARGV[1])
    redis.call('INCR', KEYS[2])

    -- ç»­æœŸ
    redis.call('EXPIRE', KEYS[1], ARGV[2])
    redis.call('EXPIRE', KEYS[2], ARGV[3])

    return 1 -- è¿”å› 1 ä»£è¡¨ç‚¹èµæˆåŠŸ
end
```

##### 2.5 MQæ¶ˆæ¯èšåˆæ¶ˆè´¹å®ç°å‚è€ƒ(JDK21+)ï¼š

```java
@Slf4j
@Component
@RequiredArgsConstructor
public class LikeConsumer {

    private final LikeMapper likeMapper;

    private final CommentIndexMapper commentIndexMapper;

    private final RedisTemplate<String, String> stringRedisTemplate;

    // å†…å­˜ç¼“å†²é˜Ÿåˆ—
    private final BlockingQueue<Like> bufferQueue = new LinkedBlockingQueue<>();

    private final TransactionTemplate transactionTemplate;

    // å‚æ•°é…ç½®
    private static final int BATCH_SIZE = 900;
    private static final int FLUSH_INTERVAL_SECONDS = 3;

    // JDK 21: è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œå™¨ (ä¸“é—¨ç”¨äºæ‰§è¡Œ IO æ“ä½œ)
    private final ExecutorService ioExecutor = Executors.newVirtualThreadPerTaskExecutor();

    // èšåˆçº¿ç¨‹ (å•çº¿ç¨‹å³å¯ï¼Œå› ä¸ºå®ƒåªè´Ÿè´£åˆ†å‘ä»»åŠ¡ï¼Œä¸è´Ÿè´£æ‰§è¡Œ)
    private final ExecutorService aggregatorExecutor = Executors.newSingleThreadExecutor();

    @PostConstruct
    public void init() {
        // å¯åŠ¨èšåˆè°ƒåº¦å™¨
        aggregatorExecutor.submit(this::aggregationLoop);
    }

    @RabbitListener(queues = RabbitMQMessageConfig.QUEUE_NAME_LIKE, concurrency = "3-10")
    @Description("æŒ‰æ—¶é—´èšåˆï¼ŒåŒæ­¥ç‚¹èµè®°å½•è‡³æ•°æ®åº“")
    public void handleMessage(Like message) {
        // ç”Ÿäº§è€…æå¿«ï¼Œä¸é˜»å¡
        bufferQueue.offer(message);
    }

    /**
     * èšåˆå¾ªç¯ (é•¿æœŸè¿è¡Œ)
     */
    private void aggregationLoop() {
        while (!Thread.currentThread().isInterrupted()) {
            try {
                List<Like> batch = new ArrayList<>();

                // 1. å¸¦è¶…æ—¶çš„è·å– (å®ç°æ—¶é—´çª—å£èšåˆ)
                Like first = bufferQueue.poll(FLUSH_INTERVAL_SECONDS, TimeUnit.SECONDS);

                if (first != null) {
                    batch.add(first);
                    // 2. å°½å¯èƒ½å¤šæï¼Œç›´åˆ°æ»¡äº†
                    bufferQueue.drainTo(batch, BATCH_SIZE - 1);
                }

                // 3. å¦‚æœæœ‰æ•°æ®ï¼Œæäº¤ç»™è™šæ‹Ÿçº¿ç¨‹å»æ‰§è¡Œ DB æ“ä½œ
                if (!batch.isEmpty()) {
                    // å…³é”®ç‚¹ï¼šè¿™é‡Œä¸å†åŒæ­¥ç­‰å¾… processBatch å®Œæˆ
                    // è€Œæ˜¯â€œå‘åå³å¿˜â€ï¼Œè®©è™šæ‹Ÿçº¿ç¨‹å»æ‰› IO
                    // æ³¨æ„ï¼šéœ€è¦æ‹·è´ä¸€ä»½ listï¼Œå› ä¸º batch ä¼šè¢«æ¸…ç©ºé‡ç”¨
                    List<Like> taskList = new ArrayList<>(batch);

                    ioExecutor.submit(() -> processBatch(taskList));
                }

            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
                break;
            } catch (Exception e) {
                log.error("èšåˆå¾ªç¯å¼‚å¸¸", e);
            }
        }
    }

    /**
     * è€—æ—¶çš„ IO æ“ä½œ
     */
    private void processBatch(List<Like> messages) {
        try {
            // 1. èšåˆç‚¹èµåˆ—è¡¨
            Map<String, Like> uniqueMap = new HashMap<>();
            for (Like item : messages) {
                String key = item.getUserId() + "_" + item.getCommentId();
                uniqueMap.put(key, item);
            }
            List<Like> optimizedList = new ArrayList<>(uniqueMap.values());

            log.debug("è™šæ‹Ÿçº¿ç¨‹ {} å¼€å§‹æ‰§è¡Œæ‰¹é‡å†™å…¥ï¼Œæ¡æ•°: {}", Thread.currentThread(), optimizedList.size());
            long start = System.currentTimeMillis();

            // ================= Refactored Start =================

            // 2. æå–ä¸é‡å¤çš„ commentId åˆ—è¡¨
            // åŸå› ï¼šå¤šä¸ªç”¨æˆ·å¯èƒ½ç‚¹èµåŒä¸€ä¸ªè¯„è®ºï¼ŒDBæ‰¹é‡æ›´æ–°æ—¶åŒä¸€ä¸ªIDåªéœ€æ›´æ–°ä¸€æ¬¡
            List<Long> distinctCommentIds = optimizedList.stream()
                    .map(Like::getCommentId)
                    .distinct()
                    .toList();

            List<CommentHeatDto> heatDtoList = new ArrayList<>();

            if (!distinctCommentIds.isEmpty()) {
                // 3. ä½¿ç”¨ Pipeline æ‰¹é‡æŸ¥è¯¢ Redis
                List<Object> pipelineResults = stringRedisTemplate.executePipelined(new SessionCallback<>() {
                    @Override
                    public <K, V> Object execute(@NotNull RedisOperations<K, V> operations) throws DataAccessException {
                        for (Long commentId : distinctCommentIds) {
                            String redisKey = LIKE_COUNT_KEY_PREFIX + commentId;
                            // ä»…è¿›å…¥é˜Ÿåˆ—ï¼Œä¸ç«‹å³æ‰§è¡Œ
                            operations.opsForValue().get(redisKey);
                        }
                        // å¿…é¡»è¿”å› null
                        return null;
                    }
                });

                // 4. å¤„ç†ç»“æœ (Pipelineè¿”å›çš„åˆ—è¡¨é¡ºåºä¸è¯·æ±‚é¡ºåºä¸¥æ ¼ä¸€è‡´)
                for (int i = 0; i < distinctCommentIds.size(); i++) {
                    Object result = pipelineResults.get(i);
                    // å¦‚æœ result ä¸ä¸º nullï¼Œè¯´æ˜ Redis ä¸­æœ‰æ•°æ® (æ²¡æœ‰Keyå°±ä¸æ›´æ–°)
                    if (result != null) {
                        Long commentId = distinctCommentIds.get(i);
                        // StringRedisTemplate è¿”å›çš„ä¸€èˆ¬æ˜¯ String
                        Integer heat = Integer.valueOf(result.toString());

                        // æ„å»º DTO
                        heatDtoList.add(new CommentHeatDto(commentId,heat));
                    }
                }
            }
            // ================= Refactored End =================

            // 5. å¼€å¯äº‹åŠ¡æ‰§è¡Œæ•°æ®åº“æ“ä½œ
            if (!optimizedList.isEmpty()) {
                transactionTemplate.execute(status -> {
                    // æ‰¹é‡æ’å…¥ç‚¹èµè®°å½•
                    if (!optimizedList.isEmpty()) {
                        likeMapper.batchInsert(optimizedList);
                    }
                    // æ‰¹é‡æ›´æ–°çƒ­åº¦ (ä»…æ›´æ–° Redis ä¸­å­˜åœ¨çš„)
                    if (!heatDtoList.isEmpty()) {
                        commentIndexMapper.batchUpdateHeat(heatDtoList);
                    }
                    return null;
                });
            }

            log.debug("å†™å…¥å®Œæˆï¼Œè€—æ—¶: {}msï¼Œç‚¹èµè½åº“: {} æ¡ï¼Œçƒ­åº¦æ›´æ–°: {} æ¡",
                    System.currentTimeMillis() - start, optimizedList.size(), heatDtoList.size());

        } catch (Exception e) {
            log.error("æ‰¹é‡å†™å…¥å¤±è´¥", e);
        }
    }

    @PreDestroy
    public void destroy() {
        // ä¼˜é›…å…³é—­
        aggregatorExecutor.shutdownNow();
        ioExecutor.close(); // JDK 21 æ–°å¢çš„ close æ–¹æ³•ï¼Œä¼šç­‰å¾…ä»»åŠ¡å®Œæˆ
    }
}
```

**âš ï¸ä¸Šé¢çš„å®ç°ä»…ä¾›å‚è€ƒï¼Œæœªç»ä¸¥æ ¼æµ‹è¯•ï¼Œè¯·æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ã€‚**

>  å®Œæ•´ä»£ç è¯·ç§»æ­¥ä»£ç ä»“åº“ï¼š[GitHub - l0sgAi/car-rental-backend at new_comment](https://github.com/l0sgAi/car-rental-backend/tree/new_comment)

---

## II. è¯„è®ºç³»ç»Ÿ

è¯„è®ºåŒºçš„è¯„è®ºä¸ºåŒå±‚ç»“æ„ï¼Œä½¿ç”¨`parentId`å’Œ`followCommentId`æ¥è¡¨ç¤ºå›å¤å’Œçˆ¶å­å…³ç³»ã€‚é¡¶çº§è¯„è®ºè¿›è¡Œåˆ†é¡µåŠ è½½ï¼Œå›å¤åˆ™é»˜è®¤å…¨éƒ¨æŠ˜å ï¼Œåªæ˜¾ç¤ºå›å¤æ•°é‡ï¼Œé€šè¿‡æ‰‹åŠ¨ç‚¹å‡»â€œæŸ¥çœ‹`n`æ¡å›å¤â€æ¥æ‰‹åŠ¨åˆ†é¡µè·å–ã€‚

*è¿™é‡Œé‡‡ç”¨è¯„è®ºç´¢å¼•å’Œè¯„è®ºå†…å®¹åˆ†ç¦»çš„è¡¨è®¾è®¡ï¼Œä»¥æ›´å¥½çš„è®¾è®¡ç¼“å­˜ã€‚*

### 1.è¡¨è®¾è®¡

æ•°æ®åº“è¡¨ç›®å‰é‡‡ç”¨MySQLï¼Œè¯„è®ºç›¸å…³è¡¨ç»“æ„å¦‚ä¸‹ï¼š

##### ä¸»é¢˜è¡¨ (è¿™é‡Œæ˜¯è½¦è¾†ä¿¡æ¯)

> è¯„è®ºä¸»é¢˜è¡¨ä¸ºè¯„è®ºåŒºçš„ä¸»é¢˜èšåˆä¿¡æ¯ï¼Œå³è¯„è®ºå¯¹åº”çš„å®ä½“ã€‚  

```sql
-- è½¦è¾†ä¿¡æ¯è¡¨  
CREATE TABLE `car`  
(  
    `id`               bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',    `brand_id`         bigint unsigned NOT NULL COMMENT 'å“ç‰ŒID',  
    `name`             varchar(50)     NOT NULL COMMENT 'è½¦è¾†å',  
    `number`           varchar(50)     NOT NULL COMMENT 'è½¦ç‰Œå·',  
    `min_rental_days`  int             NOT NULL COMMENT 'æœ€å°ç§Ÿèµå¤©æ•°',  
    `daily_rent`       decimal(10, 2)  NOT NULL COMMENT 'æ—¥ç§Ÿé‡‘(äººæ°‘å¸å…ƒ)',  

    `car_type`         varchar(50)              DEFAULT NULL COMMENT 'è½¦å‹',  
    `power_type`       varchar(50)              DEFAULT NULL COMMENT 'åŠ¨åŠ›ç±»å‹',  
    `purchase_time`    date                     DEFAULT NULL COMMENT 'è½¦è¾†è´­ä¹°æ—¥æœŸ',  
    `horsepower`       int                      DEFAULT NULL COMMENT 'é©¬åŠ›',  
    `torque`           int                      DEFAULT NULL COMMENT 'æœ€å¤§æ‰­çŸ©',  
    `fuel_consumption` int                      DEFAULT NULL COMMENT 'ç™¾å…¬é‡Œæ²¹è€—(L/100km)',  
    `endurance`        int                      DEFAULT NULL COMMENT 'ç†è®ºç»­èˆªkm',  
    `description`      varchar(1536)            DEFAULT NULL COMMENT 'æè¿°',  
    `size`             varchar(50)              DEFAULT NULL COMMENT 'å°ºå¯¸ï¼Œé•¿Ã—å®½Ã—é«˜',  
    `seat`             int                      DEFAULT NULL COMMENT 'åº§ä½æ•°',  
    `weight`           int                      DEFAULT NULL COMMENT 'è½¦é‡(kg)',  
    `volume`           int                      DEFAULT NULL COMMENT 'å‚¨ç‰©å®¹ç§¯(L)',  
    `acceleration`     decimal(4, 1)            DEFAULT NULL COMMENT 'ç™¾å…¬é‡ŒåŠ é€Ÿ(s)',  
    `images`           varchar(1536)            DEFAULT NULL COMMENT 'å›¾ç‰‡urlåˆ—è¡¨,é€—å·åˆ†éš”ï¼Œæœ€å¤š9å¼ å›¾ç‰‡',  

    `status`           tinyint         NOT NULL DEFAULT '0' COMMENT 'è½¦è¾†çŠ¶æ€ï¼š0=æ­£å¸¸ï¼Œ1=ä¸å¯ç§Ÿ',  
    `hot_score`        int             NOT NULL DEFAULT '0' COMMENT 'çƒ­åº¦è¯„åˆ†',  
    `avg_score`        int             NOT NULL DEFAULT '0' COMMENT 'è½¦è¾†ç”¨æˆ·å¹³å‡è¯„åˆ†',  

    `create_time`      datetime        NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',  
    `update_time`      datetime        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',  
    `deleted`          tinyint         NOT NULL DEFAULT '0' COMMENT 'é€»è¾‘åˆ é™¤ï¼š0=æ­£å¸¸ï¼Œ1=å·²åˆ é™¤',  
    PRIMARY KEY (`id`)) ENGINE = InnoDB  
  AUTO_INCREMENT = 1  DEFAULT CHARSET = utf8mb4  COLLATE = utf8mb4_0900_ai_ci COMMENT ='è½¦è¾†ä¿¡æ¯è¡¨';  
```

---  

##### è¯„è®ºç´¢å¼•è¡¨

> è¯„è®ºç´¢å¼•è¡¨åªæ„å»ºè¯„è®ºçš„ç»“æ„ç´¢å¼•ï¼Œä¸å‚¨å­˜å®é™…çš„è¯„è®ºç»†èŠ‚ã€‚  

```sql
-- è¯„è®ºç´¢å¼•è¡¨  
CREATE TABLE `comment_index`  
(  
    `id`                bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',    `user_id`           bigint unsigned NOT NULL COMMENT 'å¯¹åº”ç”¨æˆ·ID',  
    `car_id`            bigint unsigned NOT NULL COMMENT 'å¯¹åº”è½¦è¾†ID',  
    `parent_comment_id` bigint unsigned NOT NULL DEFAULT '0' COMMENT 'çˆ¶çº§è¯„è®ºid,é»˜è®¤0å³ä¸ºé¡¶çº§è¯„è®º',  
    `follow_comment_id` bigint unsigned NOT NULL DEFAULT '0' COMMENT 'å›å¤è¯„è®ºid,é»˜è®¤0å³éå›å¤è¯„è®º',  
    `hot_score`         int unsigned NOT NULL DEFAULT '0' COMMENT 'çƒ­åº¦-ç›®å‰åªç”¨ç‚¹èµæ•°å®ç°',  

    `create_time`       datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',  
    `update_time`       datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',  
    `deleted`           tinyint NOT NULL DEFAULT '0' COMMENT 'é€»è¾‘åˆ é™¤ï¼š0=æ­£å¸¸ï¼Œ1=å·²åˆ é™¤',  
    PRIMARY KEY (`id`)) ENGINE = InnoDB  
  AUTO_INCREMENT = 1  DEFAULT CHARSET = utf8mb4  COLLATE = utf8mb4_0900_ai_ci COMMENT ='è¯„è®ºç´¢å¼•è¡¨';  

-- æ¨èç´¢å¼•ï¼Œå¿…é¡»åŒ…å« car_id ç”¨äºåˆ†ç‰‡è·¯ç”±ï¼Œhot_score ç”¨äºæ’åºï¼Œcreate_timeæ’åºè¡¥å……
ALTER TABLE `comment_index` ADD INDEX `idx_car_hot` (`car_id`, `parent_comment_id`, `hot_score` DESC, `create_time` DESC);
```

---  

##### è¯„è®ºè¯¦æƒ…è¡¨

> è¯„è®ºè¯¦æƒ…å†å‚¨å­˜å…·ä½“çš„è¯„è®ºæ•°æ®ï¼Œå®ç°äº†è¯„è®ºç»“æ„å’Œè¯„è®ºå†…å®¹çš„è§£è€¦ï¼Œè¿™æ ·çš„è¯ï¼Œå¯ä»¥å¾ˆå¥½çš„é˜²æ­¢åœ¨ç¼“å­˜è¿‡ç¨‹ä¸­å‡ºç°å¤§keyçš„é—®é¢˜ã€‚  

```sql
-- è¯„è®ºè¯¦æƒ…è¡¨  
CREATE TABLE `comment_detail`  
(  
    `id`                bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID',    `index_id`          bigint unsigned NOT NULL COMMENT 'å¯¹åº”ç´¢å¼•ID',  
    `content`           varchar(1024) NOT NULL COMMENT 'è¯„è®ºå†…å®¹',  
    `score`             int unsigned DEFAULT NULL COMMENT 'è¿‘æœŸè®¢å•è¯„åˆ†',  
    `extra_images`      JSON DEFAULT NULL COMMENT 'è¯„è®ºå›¾ç‰‡URLåˆ—è¡¨(JSONæ•°ç»„)',  
    `create_time`       datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',  
    `update_time`       datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',  
    `deleted`           tinyint NOT NULL DEFAULT '0' COMMENT 'é€»è¾‘åˆ é™¤ï¼š0=æ­£å¸¸ï¼Œ1=å·²åˆ é™¤',  
    PRIMARY KEY (`id`)) ENGINE = InnoDB  
  AUTO_INCREMENT = 1  DEFAULT CHARSET = utf8mb4  COLLATE = utf8mb4_0900_ai_ci COMMENT ='è¯„è®ºè¯¦æƒ…è¡¨';  
```

---  

##### å¤–éƒ¨å…³è”è¡¨

å¼•å…¥ä¸€ä¸ªé¢å¤–çš„ä¸šåŠ¡èƒŒæ™¯ï¼šå¦‚æœç”¨æˆ·å¯¹äºæŸä¸ªè½¦è¾†ï¼Œæœ‰å®Œæˆä¸”æ‰“åˆ†çš„è®¢å•ï¼Œç”¨æˆ·è¯„è®ºä¼šé¢å¤–æ˜¾ç¤ºæœ€è¿‘ä¸€æ¬¡çš„è®¢å•çš„æ‰“åˆ†ã€‚  

**å…·ä½“çš„ä¸šåŠ¡å®ç°å¦‚ä¸‹ï¼š**  

> ç”¨æˆ·å‘é€è¯„è®ºæ—¶ï¼ŒæŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚æœè¯„è®ºçš„è½¦è¾†ä¹‹å‰æœ‰è®¢å•è¯„åˆ†åˆ†æ•°ï¼ŒæŠŠæœ€è¿‘çš„ä¸€æ¬¡è®¢å•è¯„åˆ†æ’å…¥åˆ°è¯„è®ºè¯¦æƒ…çš„scoreå­—æ®µä¸­ (create_time descï¼Œlimit 1)ã€‚å³ä¸€ä¸ªå½“æ—¶è¯„åˆ†çš„å¿«ç…§ã€‚  

```sql
-- è®¢å•è¡¨  
CREATE TABLE `rental_order`  
(  
 `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT 'ID', `user_id` bigint unsigned NOT NULL COMMENT 'å¯¹åº”ç”¨æˆ·ID',  
 `car_id` bigint unsigned NOT NULL COMMENT 'å¯¹åº”è½¦è¾†ID',  
 `trade_no` varchar(255) NOT NULL COMMENT 'æ”¯ä»˜å®è®¢å•ç¼–å·',   
 `start_rental_time` date NOT NULL COMMENT 'è½¦è¾†èµ·ç§Ÿæ—¥æœŸ',  
 `end_rental_time` date NOT NULL COMMENT 'è½¦è¾†è¿˜è½¦æ—¥æœŸ',  
 `price` decimal(10, 2) NOT NULL COMMENT 'è®¢å•æ€»é¢(äººæ°‘å¸å…ƒ)',  
 `address` varchar(255) NOT NULL COMMENT 'å–è¿˜è½¦åœ°å€',   
 `status` tinyint NOT NULL DEFAULT '0' COMMENT 'è®¢å•çŠ¶æ€ï¼š0=æ–°å»º/å¾…æ”¯ä»˜ï¼Œ1=å·²æ”¯ä»˜ï¼Œ2=ç§Ÿèµä¸­ï¼Œ3=å·²å®Œæˆï¼Œ4=å·²å–æ¶ˆ 5=å¾…é€€æ¬¾ 6=å·²é€€æ¬¾',  
 `score` int DEFAULT NULL COMMENT 'è®¢å•è¯„åˆ†0-10ï¼Œè®¡å…¥è½¦è¾†å‡åˆ†',   
 `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',  
 `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',  
 `deleted` tinyint NOT NULL DEFAULT '0' COMMENT 'é€»è¾‘åˆ é™¤ï¼š0=æ­£å¸¸ï¼Œ1=å·²åˆ é™¤',  
 PRIMARY KEY (`id`)) ENGINE = InnoDB  
 AUTO_INCREMENT = 1 DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_0900_ai_ci COMMENT ='è®¢å•ä¿¡æ¯è¡¨';  
```

### 2. æ–°å¢è¯„è®ºçš„å®ç°-å¸¦å®¡æ ¸æµç¨‹

**å…¥å‚**ï¼šè¯„è®ºä¿¡æ¯Dto/ç”¨æˆ·ID

é€»è¾‘é“¾è·¯ï¼š

1. æ„å»ºè¯„è®ºç´¢å¼•å®ä½“å¹¶æ’å…¥ï¼Œè®¾ç½®çŠ¶æ€ä¸ºæœªè¿‡å®¡ï¼Œå…ˆä¸æ˜¾ç¤º

2. æ„å»ºè¯„è®ºè¯¦æƒ…å®ä½“å¹¶æ’å…¥ï¼Œè®¾ç½®çŠ¶æ€ä¸ºæœªè¿‡å®¡ï¼Œå…ˆä¸æ˜¾ç¤º

3. å‘é€æ¶ˆæ¯åˆ°MQè®©LLMæ‰§è¡Œå®¡æ ¸ï¼Œå®¡æ ¸é€šè¿‡å°±æ›´æ–°çŠ¶æ€

##### 2.1 æœåŠ¡å±‚å‚è€ƒå®ç°

```java
@Override
@Transactional
public ResultCodeEnum add(CommentDto comment, Long userId) {
    // userIdåç«¯æ£€æŸ¥
    comment.setUserId(userId);
    comment.setCreateTime(Date.from(Instant.now()));
    comment.setUpdateTime(Date.from(Instant.now()));
    // æ„å»ºç´¢å¼•
    CommentIndex commentIndex = new CommentIndex();
    commentIndex.setUserId(userId);
    commentIndex.setCarId(comment.getCarId());
    commentIndex.setParentCommentId(comment.getParentCommentId());
    commentIndex.setFollowCommentId(comment.getFollowCommentId());
    commentIndex.setHotScore(0);
    commentIndex.setCreateTime(comment.getCreateTime());
    commentIndex.setUpdateTime(comment.getUpdateTime());
    // å®¡æ ¸ç»“æŸå‰éƒ½ç½®ä¸º1å·²ç»åˆ é™¤ï¼Œä¸åšå±•ç¤º
    commentIndex.setDeleted(1);
    // æ‰§è¡Œæ’å…¥
    commentIndexMapper.insert(commentIndex);
    // æ„å»ºè¯¦æƒ…
    CommentDetail commentDetail = new CommentDetail();
    commentDetail.setIndexId(commentIndex.getId());
    commentDetail.setContent(comment.getContent());
    // scoreä»ç”¨æˆ·è®¢å•ä¸­æŸ¥è¯¢
    Integer score = rentalOrderMapper.getScoreByUserIdAndCarId(userId, comment.getCarId());
    commentDetail.setScore(score);
    commentDetail.setExtraImages(comment.getExtraImages());
    commentDetail.setCreateTime(comment.getCreateTime());
    commentDetail.setUpdateTime(comment.getUpdateTime());
    // å®¡æ ¸ç»“æŸå‰éƒ½ç½®ä¸º1å·²ç»åˆ é™¤ï¼Œä¸åšå±•ç¤º
    commentDetail.setDeleted(1);
    commentDetailMapper.insert(commentDetail);
    // å‘ç»™æ¶ˆæ¯é˜Ÿåˆ—æ‰§è¡Œå®¡æ ¸
    sender.sendCarReview(RabbitMQMessageConfig.EXCHANGE_NAME,
            RabbitMQMessageConfig.ROUTING_KEY_COMMENT_CENSOR,
            new ReviewDto(commentIndex.getId(), commentDetail.getId(), commentDetail.getContent()));
    return ResultCodeEnum.SUCCESS;
}
```

##### 2.2 å®¡æ ¸æ›´æ–°æµç¨‹å‚è€ƒå®ç°

```java
/**
 * AIå®¡æ ¸ï¼Œé»˜è®¤ä½¿ç”¨SpringAIï¼Œå¼‚æ­¥è¯·æ±‚3-10ä¸ªçº¿ç¨‹å¤„ç†
 */
@RabbitListener(queues = RabbitMQMessageConfig.QUEUE_NAME_COMMENT_CENSOR, concurrency = "3-10")
@Description("å®¡æ ¸è¯„è®º")
@Transactional
public void receiveCommentCensor(ReviewDto reviewDto) {
    log.info("[MQ]æ¶ˆè´¹è€…æ”¶åˆ°æ¶ˆæ¯ï¼š{}", reviewDto);

    AiConfig aiConfig = commentService.getDefaultConfig();

    // è°ƒç”¨å¤§æ¨¡å‹
    String s = modelBuilder.buildModelWithoutMemo(
            aiConfig,
            SYS_CENSOR_PROMPT,
            reviewDto.getContent());

    if ("0".equals(s)) {
        try {
            // å®¡æ ¸é€šè¿‡ï¼Œæ›´æ–°è¯„è®ºæ˜¾ç¤ºçŠ¶æ€
            CommentIndex commentIndex = new CommentIndex();
            commentIndex.setId(reviewDto.getIndexId());
            commentIndex.setDeleted(0);
            commentIndexMapper.updateByPrimaryKeySelective(commentIndex);
            CommentDetail commentDetail = new CommentDetail();
            commentDetail.setId(reviewDto.getDetailId());
            commentDetail.setDeleted(0);
            commentDetailMapper.updateByPrimaryKeySelective(commentDetail);
        } catch (Exception e) {
            log.error("[MQï¼šç”¨æˆ·å‘é€è¯„è®º] æ’å…¥æ•°æ®åº“å¤±è´¥", e);
        }
    }
}
```

### 3. åˆ†é¡µæŸ¥è¯¢è¯„è®ºçš„å®ç°

**å…¥å‚**ï¼šcarId/parentCommentId

**é€»è¾‘é“¾è·¯**ï¼š

1. æ ¹æ®carIdåˆ†é¡µæŸ¥è¯¢æŸ¥è¯¢é¡¶çº§ç´¢å¼•  

2. å°è£…å›å¤æ¡æ•°ç­‰ï¼Œä¾›å‰ç«¯å›æ˜¾

3. å¼‚æ­¥è·å–è¯„è®ºå†…å®¹ä¸ç‚¹èµæƒ…å†µ

4. å°è£…voå¹¶è¿”å›

##### 3.1 è·å–è¯„è®ºåˆ—è¡¨çš„æ–¹æ³•

```java
/**
 * è¯„è®ºåˆ—è¡¨å¼‚æ­¥ç¼–æ’ç»„è£…
 */
@Override
public List<CommentVo> queryByCarId(Long carId) {
    // æŸ¥è¯¢1çº§è¯„è®ºç´¢å¼• limit10ï¼Œå¸¦å›å¤æ•°é‡
    List<CommentIndexDto> indexes = commentIndexMapper.queryByCarIdWithLimit(carId, 10);

    if (indexes.isEmpty()) {
        return Collections.emptyList();
    }
    Long curUserId = StpUtil.getLoginIdAsLong();

    // æå–æ‰€æœ‰æ¶‰åŠçš„ commentIdï¼Œç”¨äºæ‰¹é‡æŸ¥è¯¢
    List<Long> commentIds = indexes.stream().map(CommentIndexDto::getId).collect(Collectors.toList());

    // ================== å¼‚æ­¥ä»»åŠ¡ç¼–æ’å¼€å§‹ ==================

    // 2. å¼‚æ­¥ä»»åŠ¡ Aï¼šæŸ¥è¯¢è¯„è®ºå†…å®¹ï¼ˆå¸¦å¤šçº§ç¼“å­˜ç­–ç•¥ï¼‰
    CompletableFuture<Map<Long, CommentDetail>> contentFuture = CompletableFuture
            .supplyAsync(() -> getCommentContentMap(commentIds), vtExecutor);

    // 3. å¼‚æ­¥ä»»åŠ¡ Bï¼šæŸ¥è¯¢ç‚¹èµæ•°æ®ï¼ˆç‚¹èµæ•° + å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµï¼‰
    CompletableFuture<Map<Long, LikeInfoVo>> likeFuture = CompletableFuture
            .supplyAsync(() -> getCommentLikeMap(commentIds, curUserId), vtExecutor);

    CompletableFuture.allOf(contentFuture, likeFuture).join();

    // ================== æ•°æ®ç»„è£… ==================

    Map<Long, CommentDetail> contentMap = contentFuture.getNow(Collections.emptyMap());
    Map<Long, LikeInfoVo> likeMap = likeFuture.getNow(Collections.emptyMap());

    // 5. åˆ†ç»„ä¸å°è£… (çˆ¶å­è¯„è®ºå½’ä½)
    // æ‰¾å‡ºæ‰€æœ‰ä¸€çº§è¯„è®º (å‡è®¾ parentId ä¸º 0 æˆ– null ä»£è¡¨ä¸€çº§)
    // å¯»æ‰¾è¯¥ä¸€çº§è¯„è®ºä¸‹çš„äºŒçº§è¯„è®º (Reply)
    // å‡è®¾æœ‰rootParentIdæŒ‡å‘é¡¶çº§

    return indexes.stream()
            .map(index -> convertToVo(index, contentMap, likeMap))
            .collect(Collectors.toList());
}
```

##### 3.2 åŠ è½½å›å¤çš„æ–¹æ³•

```java
@Override
@Description("åˆ†é¡µåŠ è½½å›å¤")
public List<CommentVo> loadReplyByCommentId(Long parentCommentId) {
    // æŸ¥è¯¢1çº§è¯„è®ºç´¢å¼• limit20ï¼Œå¸¦å›å¤æ•°é‡ï¼Œè¦†ç›–å‰10æ¡
    List<CommentIndexDto> indexes = commentIndexMapper.queryReplyWithLimit(parentCommentId);

    if (indexes.isEmpty()) {
        return Collections.emptyList();
    }
    Long curUserId = StpUtil.getLoginIdAsLong();

    // æå–æ‰€æœ‰æ¶‰åŠçš„ commentIdï¼Œç”¨äºæ‰¹é‡æŸ¥è¯¢
    List<Long> commentIds = indexes.stream().map(CommentIndexDto::getId).collect(Collectors.toList());

    // ================== å¼‚æ­¥ä»»åŠ¡ç¼–æ’å¼€å§‹ ==================

    // 2. å¼‚æ­¥ä»»åŠ¡ Aï¼šæŸ¥è¯¢è¯„è®ºå†…å®¹ï¼ˆå¸¦å¤šçº§ç¼“å­˜ç­–ç•¥ï¼‰
    CompletableFuture<Map<Long, CommentDetail>> contentFuture = CompletableFuture
            .supplyAsync(() -> getCommentContentMap(commentIds), vtExecutor);

    // 3. å¼‚æ­¥ä»»åŠ¡ Bï¼šæŸ¥è¯¢ç‚¹èµæ•°æ®ï¼ˆç‚¹èµæ•° + å½“å‰ç”¨æˆ·æ˜¯å¦ç‚¹èµï¼‰
    CompletableFuture<Map<Long, LikeInfoVo>> likeFuture = CompletableFuture
            .supplyAsync(() -> getCommentLikeMap(commentIds, curUserId), vtExecutor);

    CompletableFuture.allOf(contentFuture, likeFuture).join();

    // ================== æ•°æ®ç»„è£… ==================

    Map<Long, CommentDetail> contentMap = contentFuture.getNow(Collections.emptyMap());
    Map<Long, LikeInfoVo> likeMap = likeFuture.getNow(Collections.emptyMap());

    // 5. åˆ†ç»„ä¸å°è£… (çˆ¶å­è¯„è®ºå½’ä½)
    // æ‰¾å‡ºæ‰€æœ‰ä¸€çº§è¯„è®º (å‡è®¾ parentId ä¸º 0 æˆ– null ä»£è¡¨ä¸€çº§)
    // å¯»æ‰¾è¯¥ä¸€çº§è¯„è®ºä¸‹çš„äºŒçº§è¯„è®º (Reply)
    // å‡è®¾æœ‰rootParentIdæŒ‡å‘é¡¶çº§

    return indexes.stream()
            .map(index -> convertToVo(index, contentMap, likeMap))
            .collect(Collectors.toList());
}
```

##### 3.3 è·å–è¯„è®ºå†…å®¹çš„å°è£…å‡½æ•°

```java
/**
 * è·å–è¯„è®ºå†…å®¹ Map
 * ä¼˜åŒ–ç­–ç•¥: MultiGet(Redis) -> BatchSelect(DB) -> Pipeline SetEx(Redis)
 */
private Map<Long, CommentDetail> getCommentContentMap(List<Long> commentIds) {
    Map<Long, CommentDetail> resultMap = new HashMap<>();

    // 1. æ„é€  Redis Keys
    List<String> keys = commentIds.stream()
            .map(id -> COMMENT_CACHE_KEY_PREFIX + id)
            .collect(Collectors.toList());

    // 2. æ‰¹é‡æŸ¥è¯¢ Redis
    List<Object> cacheResults = redisTemplate.opsForValue().multiGet(keys);

    List<Long> missingIds = new ArrayList<>();

    // 3. åˆ†ç¦»å‘½ä¸­ä¸æœªå‘½ä¸­
    for (int i = 0; i < commentIds.size(); i++) {
        Long id = commentIds.get(i);
        Object value = (cacheResults != null && cacheResults.size() > i) ? cacheResults.get(i) : null;
        if (value instanceof CommentDetail) {
            resultMap.put(id, (CommentDetail) value);
        } else {
            missingIds.add(id);
        }
    }

    // 4. å¤„ç†æœªå‘½ä¸­ï¼šæŸ¥åº“ + Pipeline å›å¡«
    if (!missingIds.isEmpty()) {
        List<CommentDetail> dbDetails = commentDetailMapper.selectBatchIds(missingIds);

        // å‡†å¤‡å›å¡«çš„æ•°æ®
        Map<String, CommentDetail> cacheUploadMap = new HashMap<>();
        for (CommentDetail detail : dbDetails) {
            resultMap.put(detail.getId(), detail);
            cacheUploadMap.put(COMMENT_CACHE_KEY_PREFIX + detail.getIndexId(), detail);
        }

        if (!cacheUploadMap.isEmpty()) {
            // ä½¿ç”¨ Pipeline + SetEx æ›¿ä»£ multiSetï¼Œæ”¯æŒè¿‡æœŸæ—¶é—´
            redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
                @SuppressWarnings("unchecked")
                RedisSerializer<String> keySerializer = (RedisSerializer<String>) redisTemplate.getKeySerializer();
                @SuppressWarnings("unchecked")
                RedisSerializer<Object> valueSerializer = (RedisSerializer<Object>) redisTemplate.getValueSerializer();

                for (Map.Entry<String, CommentDetail> entry : cacheUploadMap.entrySet()) {
                    byte[] keyBytes = keySerializer.serialize(entry.getKey());
                    byte[] valBytes = valueSerializer.serialize(entry.getValue());

                    // ç”Ÿæˆéšæœºè¿‡æœŸæ—¶é—´ï¼šåŸºç¡€æ—¶é—´ + 0~3600ç§’éšæœºå€¼ï¼Œé˜²æ­¢é›ªå´©
                    long ttl = CACHE_TTL_SECONDS + ThreadLocalRandom.current().nextInt(3600);

                    if (keyBytes != null && valBytes != null) {
                        connection.stringCommands().setEx(keyBytes, ttl, valBytes);
                    }
                }
                return null;
            });
        }
    }

    return resultMap;
}
```

##### 3.4 è·å–ç‚¹èµæƒ…å†µçš„å‡½æ•°

```java
/**
 * è·å–ç‚¹èµä¿¡æ¯ Map
 * ä¼˜åŒ–ç­–ç•¥: Pipeline Get(Redis) -> BatchSelect(DB) -> Pipeline SetEx(Redis)
 */
private Map<Long, LikeInfoVo> getCommentLikeMap(List<Long> commentIds, Long curUserId) {
    Map<Long, LikeInfoVo> resultMap = new HashMap<>();

    // 0. é¢„å¤„ç†ç”¨æˆ·ç‚¹èµé›†åˆ
    rebuildUserLikedCache(curUserId);
    String userLikeKey = USER_LIKE_KEY_PREFIX + curUserId;

    // 1. ä½¿ç”¨ Pipeline æ‰¹é‡è·å– (Count + IsLiked)
    List<Object> pipelineResults = stringRedisTemplate.executePipelined((RedisCallback<Object>) connection -> {
        for (Long id : commentIds) {
            String likeCountKey = LIKE_COUNT_KEY_PREFIX + id;

            // å‘½ä»¤ A: è·å–ç‚¹èµæ•°
            connection.stringCommands().get(likeCountKey.getBytes());

            // å‘½ä»¤ B: è·å–æ˜¯å¦ç‚¹èµ (ä»…å½“å·²ç™»å½•æ—¶æŸ¥è¯¢)
            connection.setCommands().sIsMember(userLikeKey.getBytes(), String.valueOf(id).getBytes());
        }
        return null;
    });

    // 2. è§£æç»“æœ
    // æ­¥é•¿
    int step = 2;

    List<Long> missingCountIds = new ArrayList<>();

    for (int i = 0; i < commentIds.size(); i++) {
        Long id = commentIds.get(i);
        LikeInfoVo info = new LikeInfoVo();

        // --- è§£æç‚¹èµæ•° ---
        Object countObj = pipelineResults.get(i * step);
        if (countObj != null) {
            info.setCount(Integer.parseInt((String) countObj));
        } else {
            missingCountIds.add(id);
            info.setCount(0);
        }

        // --- è§£ææ˜¯å¦ç‚¹èµ ---
        // pipelineResultså¯èƒ½ä¼šåŒ…å«nullï¼Œå¦‚æœå‘½ä»¤æ‰§è¡Œå¤±è´¥
        Object isMemberObj = pipelineResults.get(i * step + 1);
        info.setLiked(isMemberObj instanceof Boolean && (Boolean) isMemberObj);

        resultMap.put(id, info);
    }

    // 3. æ‰¹é‡æŸ¥åº“å›å¡«ç‚¹èµæ•°
    if (!missingCountIds.isEmpty()) {
        List<CommentLikeCountDto> dtos = likeMapper.selectCountsBatch(missingCountIds);

        Map<Long, Integer> dbCounts = dtos.stream()
                .collect(Collectors.toMap(CommentLikeCountDto::getCommentId, CommentLikeCountDto::getCount));

        Map<String, String> cacheUpdateMap = new HashMap<>();

        for (Long missingId : missingCountIds) {
            Integer dbCount = dbCounts.getOrDefault(missingId, 0);

            // æ›´æ–°è¿”å›ç»“æœ
            resultMap.get(missingId).setCount(dbCount);

            // å‡†å¤‡ç¼“å­˜æ•°æ®
            cacheUpdateMap.put(LIKE_COUNT_KEY_PREFIX + missingId, String.valueOf(dbCount));
        }

        if (!cacheUpdateMap.isEmpty()) {
            // ã€å…³é”®ä¼˜åŒ–ã€‘ä½¿ç”¨ Pipeline + SetEx å›å¡«ç‚¹èµæ•°
            stringRedisTemplate.executePipelined((RedisCallback<Object>) connection -> {
                for (Map.Entry<String, String> entry : cacheUpdateMap.entrySet()) {
                    byte[] keyBytes = entry.getKey().getBytes();
                    byte[] valBytes = entry.getValue().getBytes();

                    // ç‚¹èµæ•°å±äºçƒ­ç‚¹æ•°æ®ï¼Œè¿‡æœŸæ—¶é—´å¯ä»¥ç¨çŸ­ï¼Œå¹¶åŠ éšæœº
                    long ttl = CACHE_TTL_SECONDS + ThreadLocalRandom.current().nextInt(3600);

                    connection.stringCommands().setEx(keyBytes, ttl, valBytes);
                }
                return null;
            });
        }
    }

    return resultMap;
}
```

**âš ï¸ä¸Šé¢çš„å®ç°ä»…ä¾›å‚è€ƒï¼Œæœªç»ä¸¥æ ¼æµ‹è¯•ï¼Œè¯·æ ¹æ®è‡ªå·±çš„éœ€æ±‚ä¿®æ”¹ã€‚**

> å®Œæ•´ä»£ç è¯·ç§»æ­¥ä»£ç ä»“åº“ï¼š[GitHub - l0sgAi/car-rental-backend at new_comment](https://github.com/l0sgAi/car-rental-backend/tree/new_comment)

---

## æ€»ç»“

ğŸ¤¯æœ¬æ–‡ç»™å‡ºäº†ä¸€ç§è¯„è®ºå’Œç‚¹èµç³»ç»Ÿçš„è®¾è®¡æ€è·¯ï¼Œè®¾è®¡å’Œå®ç°ä¸Šå¯èƒ½æœ‰å¯ä»¥ä¼˜åŒ–çš„éƒ¨åˆ†ï¼Œå¦‚æœ‰ä»»ä½•é—®é¢˜ä¸å»ºè®®ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºè®¨è®ºï¼
